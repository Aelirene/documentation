---
title: Проксирование HTTP-запросов к стороннему сервису
keywords: sample
summary: "Раздел содержит пошаговое описание обмена сообщениями между приложением и сторонним сервисом"
sidebar: evotordoc_sidebar
permalink: doc_cloud_proxy.html
folder: evotordoc/smart_terminal_SDK
---

### Создание списка разрешённых URL

Чтобы приложение могло обмениваться сообщениями со сторонним сервисом, в настройках приложения на сайте разработчиков, требуется указать список разрешённых URL:

1. На сайте разработчиков выберите приложение, для которого требуется указать список разрешённых URL.
2. На вкладке **Интеграция**, установите флажок **ФЛАЖОК** и укажите список URL, к которым может обращаться приложение.

  Примеры:
  * `http://example\.com/document.*\.jsp\?wildcard=\*&param=value.*`;
  * `https://another\.host\.com/document.*\.jsp`;
  * `https://another\.host\.com/.*`.


После создания списка, обмен сообщениями происходит по описанному ниже процессу.

### Шаг 1. Приложение отправляет HTTP-сообщение

Приложение создаёт HTTP-сообщение и отправляет его в сторонний сервис. При этом, вы можете применять различные библиотеки или воспользоваться любым удобным способом отправки сообщения (см. примеры).

#### Пример кода для отправки сообщения из Java-приложения

{% highlight java %}
DefaultHttpClient hc = new DefaultHttpClient();
ResponseHandler response = new BasicResponseHandler();
HttpGet http = new HttpGet("http://site.ru/api.php?login=user1&psw=1234");
//получаем ответ от сервера
String response = (String) hc.execute(http, response);
{% endhighlight %}


#### Пример кода для отправки сообщения из JS-приложения

{% highlight JavaScript %}
var req = new XMLHttpRequest();
req.open("GET", "example/data.txt", false);
req.send(null);
console.log(req.responseText);
{% endhighlight %}

### Шаг 2. Терминал передаёт сообщение в облако

Терминал перехватывает сообщение и передаёт его в облако Эвотор. На этом этапе в сообщение добавляются служебные заголовки:
* `X-Device-ID`
* `X-Device-IMEI`
* `X-User-ID`
* `X-Signed-Url`
* `X-Shop-UUID`
* `X-Device-Salt`
* `X-Device-Algorithm`
* `X-Device-Date`
* `X-Secret-Device-ID`
* `X-OAuth-Client-ID`
* `X-Device-UUID`
* `X-Evotor-*`
* `Expect`
* `Host`
* `Transfer-Encoding`

{% include note.html content="Убедитесь, что ваше приложение не использует перечисленные заголовки. В противном случае, смарт-терминал перезапишет их содержимое." %}

### Шаг 3. Облако передаёт сообщение адресату

Облако удаляет служебные заголовки, добавляет свои заголовки и передаёт сообщение адресату.

Заголовки, которые добавляет облако:

* `X-Evotor-Store-Uuid` -- содержит идентификатор магазина в формате uuid4, к которому привязан терминал.
* `X-Evotor-Device-UUID` – содержит идентификатор устройства в формате uuid4, полученный по запросу к `/api/v1/inventories/devices`.
* `Authorization` -- содержит токен пользователя. Токен необходим для bearer-авторизации.

Сторонний сервер получает сообщение от облака Эвотор и определяет отправителя с помощью заголовка Authorization.

#### Шаг 4. Ответ стороннего сервиса

Ответ стороннего сервиса передаётся приложению в обратном порядке.

При этом, облако Эвотор добавляет в ответ заголовок `X-Market-request`. Заголовок определяет дошёл запрос до адресата или нет.

Ответы стороннего сервиса должны содержать объекты:
  * `status` -- содержит HTTP-код состояния.
  * `body` -- содержит тело запроса.
